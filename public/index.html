<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KLAI Chatbot — Trợ lý học tập</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chat-scroll { max-height: 60vh; overflow:auto; }
    .msg-user { background: #e0f2fe; }
    .msg-bot { background: #f1f5f9; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-lg overflow-hidden grid grid-cols-1 md:grid-cols-3">
      <div class="p-6 md:col-span-1 border-r">
        <h1 class="text-2xl font-extrabold text-blue-600">KLAI Chatbot</h1>
        <p class="mt-2 text-sm text-slate-500">Trợ lý học & dạy thông minh — chọn chế độ rồi hỏi nhé.</p>
        <div class="mt-6 space-y-3">
          <label class="block text-sm font-medium text-slate-600">Chế độ</label>
          <div id="modeButtons" class="flex gap-3 mt-2">
            <button id="mode-student" class="py-2 px-3 rounded-lg bg-blue-50 text-blue-700 border border-blue-100">Học sinh</button>
            <button id="mode-teacher" class="py-2 px-3 rounded-lg bg-white text-slate-700 border border-slate-200">Giáo viên</button>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-slate-600">Chủ đề (tuỳ chọn)</label>
            <input id="topic" class="mt-1 block w-full rounded-md border-slate-200 shadow-sm" placeholder="Ví dụ: Hàm số lớp 10" />
          </div>
          <div class="mt-4 text-sm text-slate-500">
            <p><strong>Gợi ý prompt:</strong></p>
            <ul class="list-disc ml-5 mt-2">
              <li>Học sinh: "Giải thích định nghĩa ... cho dễ hiểu".</li>
              <li>Giáo viên: "Tạo 3 câu trắc nghiệm về ... và đáp án".</li>
            </ul>
          </div>
          <div class="mt-6">
            <button id="clearBtn" class="w-full py-2 rounded-lg bg-red-100 text-red-700 border border-red-200">Xoá lịch sử</button>
          </div>
        </div>
        <footer class="mt-6 text-xs text-slate-400">
          © KLAI · Cre: Khởi & Lý
        </footer>
      </div>
      <div class="p-4 md:col-span-2 flex flex-col">
        <div class="flex-1 overflow-hidden">
          <div id="chat" class="chat-scroll p-4 space-y-4"></div>
        </div>
        <div class="mt-4 border-t pt-4">
          <form id="chatForm" class="flex gap-3">
            <input id="prompt" autocomplete="off" placeholder="Gõ câu hỏi/nhu cầu của bạn..." 
                   class="flex-1 rounded-lg border border-slate-200 p-3 shadow-sm" />
            <button id="sendBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Gửi</button>
          </form>
          <div id="status" class="mt-2 text-sm text-slate-400"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const chatEl = document.getElementById('chat');
  const form = document.getElementById('chatForm');
  const promptInput = document.getElementById('prompt');
  const topicInput = document.getElementById('topic');
  const statusEl = document.getElementById('status');
  const clearBtn = document.getElementById('clearBtn');

  let mode = 'student';
  document.getElementById('mode-student').classList.add('bg-blue-50','text-blue-700');
  document.getElementById('mode-student').addEventListener('click', () => setMode('student'));
  document.getElementById('mode-teacher').addEventListener('click', () => setMode('teacher'));
  clearBtn.addEventListener('click', () => { chatEl.innerHTML = ''; });

  function setMode(m) {
    mode = m;
    document.getElementById('mode-student').classList.toggle('bg-blue-50', m==='student');
    document.getElementById('mode-student').classList.toggle('text-blue-700', m==='student');
    document.getElementById('mode-teacher').classList.toggle('bg-blue-50', m==='teacher');
    document.getElementById('mode-teacher').classList.toggle('text-blue-700', m==='teacher');
  }

  function appendMessage(who, text) {
    const wrap = document.createElement('div');
    wrap.className = 'flex ' + (who==='user' ? 'justify-end' : 'justify-start');
    const card = document.createElement('div');
    card.className = 'max-w-[80%] p-3 rounded-lg shadow-sm ' + (who==='user' ? 'msg-user' : 'msg-bot');
    card.innerHTML = `<div class="text-xs text-slate-500 mb-1">${who==='user'? 'Bạn' : 'KLAI'}</div>
                      <div class="whitespace-pre-wrap text-sm">${escapeHtml(text)}</div>`;
    wrap.appendChild(card);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function escapeHtml(str) {
    if (!str) return '';
    return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = promptInput.value.trim();
    if (!text) return;
    appendMessage('user', text);
    promptInput.value = '';
    statusEl.textContent = 'Đang gửi cho AI...';
    try {
      const payload = { mode, topic: topicInput.value || '', prompt: text };
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const err = await res.text();
        appendMessage('bot', 'Lỗi server: ' + err);
      } else {
        const data = await res.json();
        appendMessage('bot', data.reply || '[Không có phản hồi]');
      }
    } catch(err) {
      appendMessage('bot', 'Lỗi kết nối: ' + (err.message||err));
    } finally {
      statusEl.textContent = '';
    }
  });
</script>
</body>
</html>
